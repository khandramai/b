name: Schema Changes Report on PR

on:
  pull_request:
    branches:
      - main # –í–∞—à–∞ –æ—Å–Ω–æ–≤–Ω–∞—è/—Ü–µ–ª–µ–≤–∞—è –≤–µ—Ç–∫–∞

jobs:
  report_changes:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository and fetch full history
        # fetch-depth: 0 –Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–µ–≥–∞–º–∏
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get current and previous tags
        id: tags
        run: |
          # –¢–µ–∫—É—â–∏–π –∫–æ–º–º–∏—Ç PR
          CURRENT_COMMIT=${{ github.event.pull_request.head.sha }}
          
          # –ü–æ–ª—É—á–∞–µ–º —Ö–µ—à –∫–æ–º–º–∏—Ç–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Ç–µ–≥–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
          PREVIOUS_TAG_HASH=$(git rev-list --tags --max-count=2 --skip=1 --date-order | head -n 1)
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 ${PREVIOUS_TAG_HASH} 2>/dev/null || echo "initial")
          
          # current-ref - HEAD PR, previous-ref - –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–µ–≥
          echo "current-ref=$CURRENT_COMMIT" >> $GITHUB_OUTPUT
          echo "previous-ref=$PREVIOUS_TAG" >> $GITHUB_OUTPUT

      - name: Checkout Central Action (khandramai/c)
        # –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å Action
        uses: actions/checkout@v4
        with:
          repository: khandramai/c
          token: ${{ secrets.REPO_ACCESS_TOKEN }} # –¢—Ä–µ–±—É–µ—Ç—Å—è PAT
          path: c-action

      - name: Compare Schemas and Generate Report
        id: compare_schemas
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º Action –∏–∑ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: ./c-action/.github/actions/compare-schemas
        with:
          current-ref: ${{ steps.tags.outputs.current-ref }}
          previous-ref: ${{ steps.tags.outputs.previous-ref }}
          schemas-path: 'ramls'
        # –ù–µ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—Ç—å GITHUB_WORKSPACE, —Ç.–∫. Checkout –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        # –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–ª –º–æ–¥—É–ª—å a/b –≤ –∫–æ—Ä–µ–Ω—å —Ä–∞–±–æ—á–µ–π –æ–±–ª–∞—Å—Ç–∏, –∞ action c - –≤ –ø–∞–ø–∫—É c-action.

      - name: Comment on Pull Request with Report
        uses: actions/github-script@v6
        with:
          script: |
            const report = `### üìù –û—Ç—á–µ—Ç –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –≤ —Å—Ö–µ–º–∞—Ö\n\n**–°—Ä–∞–≤–Ω–µ–Ω–∏–µ:** \`${{ steps.tags.outputs.previous-ref }}...${{ steps.tags.outputs.current-ref }}\`\n\n${{ steps.compare_schemas.outputs.report }}`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });