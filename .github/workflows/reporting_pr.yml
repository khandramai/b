name: Schema Changes Report on PR

on:
  pull_request:
    branches:
      - main # –í–∞—à–∞ –æ—Å–Ω–æ–≤–Ω–∞—è/—Ü–µ–ª–µ–≤–∞—è –≤–µ—Ç–∫–∞

jobs:
  report_changes:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository and fetch full history
        uses: actions/checkout@v4
        with:
          # –¢—Ä–µ–±—É–µ—Ç—Å—è PAT –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Action –∏–∑ –¥—Ä—É–≥–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          fetch-depth: 0

      - name: Get current and previous tags
        id: tags
        run: |
          # –¢–µ–∫—É—â–∏–π —Ä–µ—Ñ–µ—Ä–µ–Ω—Å: SHA –∫–æ–º–º–∏—Ç–∞ PR
          CURRENT_REF=${{ github.event.pull_request.head.sha }}
          
          # –ù–∞—Ö–æ–¥–∏–º SHA –≤—Ç–æ—Ä–æ–≥–æ —Å –∫–æ–Ω—Ü–∞ —Ç–µ–≥–∞.
          PREVIOUS_TAG_HASH=$(git rev-list --tags --max-count=2 --skip=1 --date-order | head -n 1)
          
          if [ -z "$PREVIOUS_TAG_HASH" ]; then
              # –ï—Å–ª–∏ —Ç–µ–≥–æ–≤ –º–µ–Ω—å—à–µ –¥–≤—É—Ö, –∏—Å–ø–æ–ª—å–∑—É–µ–º SHA –ø–µ—Ä–≤–æ–≥–æ –∫–æ–º–º–∏—Ç–∞
              PREVIOUS_REF=$(git rev-list --max-parents=0 HEAD | head -n 1)
          else
              # –ò—Å–ø–æ–ª—å–∑—É–µ–º SHA –≤—Ç–æ—Ä–æ–≥–æ —Å –∫–æ–Ω—Ü–∞ —Ç–µ–≥–∞
              PREVIOUS_REF=$(git describe --tags --abbrev=0 ${PREVIOUS_TAG_HASH} 2>/dev/null)
          fi
          
          echo "current-ref=$CURRENT_REF" >> $GITHUB_OUTPUT
          echo "previous-ref=$PREVIOUS_REF" >> $GITHUB_OUTPUT

      - name: Compare Schemas and Generate Report
        id: compare_schemas
        # –ü—Ä—è–º–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Action –∏–∑ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: khandramai/c/.github/actions/compare-schemas@main
        with:
          current-ref: ${{ steps.tags.outputs.current-ref }}
          previous-ref: ${{ steps.tags.outputs.previous-ref }}
          schemas-path: 'ramls'

      - name: Comment on Pull Request with Report
        uses: actions/github-script@v6
        with:
          script: |
            const report = `### üìù –û—Ç—á–µ—Ç –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –≤ —Å—Ö–µ–º–∞—Ö\n\n**–°—Ä–∞–≤–Ω–µ–Ω–∏–µ:** \`${{ steps.tags.outputs.previous-ref }}...${{ steps.tags.outputs.current-ref }}\`\n\n${{ steps.compare_schemas.outputs.report }}`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });