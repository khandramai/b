name: Schema Changes Report on PR

on:
  pull_request:
    branches:
      - main # –í–∞—à–∞ –æ—Å–Ω–æ–≤–Ω–∞—è/—Ü–µ–ª–µ–≤–∞—è –≤–µ—Ç–∫–∞

jobs:
  report_changes:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository and fetch full history
        uses: actions/checkout@v4
        with:
          # –î–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–µ–≥–∞–º–∏ –∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è Action –∏–∑ –¥—Ä—É–≥–æ–≥–æ —Ä–µ–ø–æ
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          fetch-depth: 0

      - name: Get current and previous tags
        id: tags
        run: |
          # –¢–µ–∫—É—â–∏–π –∫–æ–º–º–∏—Ç PR
          CURRENT_COMMIT=${{ github.event.pull_request.head.sha }}
          
          # –õ–æ–≥–∏–∫–∞ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Ç–æ—Ä–æ–≥–æ —Å –∫–æ–Ω—Ü–∞ —Ç–µ–≥–∞
          PREVIOUS_TAG_HASH=$(git rev-list --tags --max-count=2 --skip=1 --date-order | head -n 1)
          if [ -z "$PREVIOUS_TAG_HASH" ]; then
              PREVIOUS_REF="NOT_FOUND" 
          else
              PREVIOUS_REF=$(git describe --tags --abbrev=0 ${PREVIOUS_TAG_HASH} 2>/dev/null)
          fi
          
          echo "current-ref=$CURRENT_COMMIT" >> $GITHUB_OUTPUT
          echo "previous-ref=$PREVIOUS_REF" >> $GITHUB_OUTPUT

      - name: Compare Schemas and Generate Report
        id: compare_schemas
        # –ü—Ä—è–º–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Action –∏–∑ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: khandramai/c/.github/actions/compare-schemas@main
        with:
          current-ref: ${{ steps.tags.outputs.current-ref }}
          previous-ref: ${{ steps.tags.outputs.previous-ref }}
          schemas-path: 'ramls'

      - name: Comment on Pull Request with Report
        uses: actions/github-script@v6
        with:
          script: |
            const report = `### üìù –û—Ç—á–µ—Ç –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –≤ —Å—Ö–µ–º–∞—Ö\n\n**–°—Ä–∞–≤–Ω–µ–Ω–∏–µ:** \`${{ steps.tags.outputs.previous-ref }}...${{ steps.tags.outputs.current-ref }}\`\n\n${{ steps.compare_schemas.outputs.report }}`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });